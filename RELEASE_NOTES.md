# UnLeaf v1.00 リリースノート

## 概要

UnLeaf v1.00 は、Windows 11 の EcoQoS (効率モード) を自動的に無効化するシステムユーティリティです。

Python プロトタイプ (v0.xx) から C++ ネイティブへ完全移植し、イベント駆動アーキテクチャで再設計しました。ランタイム依存なし・常駐メモリ約 2MB・アイドル時 CPU 使用率ゼロで動作します。

---

## 主な機能

### EcoQoS 自動無効化
Windows 11 がプロセスに自動適用する「効率モード」(EcoQoS) を検出し、即座に解除します。タスクマネージャーで葉っぱアイコンが付く現象を防止します。

### ETW イベント駆動プロセス監視
Windows の ETW (Event Tracing for Windows) を利用し、プロセス・スレッドの生成をリアルタイムに検知します。従来のポーリング方式と異なり、イベントがないときは完全にスリープするため、CPU リソースを消費しません。

### 3フェーズ適応制御
ターゲットプロセスの状態に応じて、3段階の制御フェーズを自動切替します。

| フェーズ | 動作 | 期間 |
|----------|------|------|
| **AGGRESSIVE** | 即時制御 + 遅延検証 (200ms / 1s / 3s) | 起動後 3秒間 |
| **STABLE** | イベント駆動のみ (アクティブ監視なし) | 通常時 |
| **PERSISTENT** | 5秒間隔の定期制御 | EcoQoS 再有効化が3回以上検出された場合 |

### ETW ブースト
PERSISTENT フェーズにおいても、スレッド生成イベントに対して即時応答 (レート制限: 1回/秒) を行います。タブ切替やウィンドウ操作時の EcoQoS 再適用に対して遅延なく対処します。

### INI 設定ファイル (リアルタイムリロード)
`UnLeaf.ini` を編集するだけで設定を変更できます。OS のファイル変更通知を利用しているため、サービスの再起動は不要です。

### GUI Manager
Windows ネイティブの管理ツールで、以下の操作が可能です:
- ターゲットプロセスの追加・削除
- ライブログ表示
- サービスのヘルスチェック
- サービスの起動・停止

### DACL セキュリティ付き IPC 通信
サービスと Manager 間の Named Pipe 通信に DACL (Discretionary Access Control List) を設定し、SYSTEM アカウントと管理者グループのみがアクセス可能です。コマンドごとに権限レベル (PUBLIC / ADMIN / SYSTEM_ONLY) を分離しています。

### システム重要プロセスの自動保護
`csrss.exe`, `lsass.exe`, `svchost.exe`, `dwm.exe` 等のシステム重要プロセスは保護リストに登録されており、ターゲットに追加しても最適化の対象外となります。

---

## 技術仕様

| 項目 | 値 |
|------|-----|
| 言語 | C++17 (MSVC) |
| ランタイム依存 | なし (静的リンク) |
| サービス スレッド数 | 3 (制御ループ / ETW / IPC) |
| 常駐メモリ | 約 2MB |
| バイナリサイズ | Service ~548KB + Manager ~635KB (合計 ~1.2MB) |
| アイドル時 CPU | 0% (WaitForMultipleObjects INFINITE) |
| ウェイクアップ頻度 | 約 6回/分 (Safety Net 10秒間隔) |
| 対応アーキテクチャ | x64 |

---

## 動作要件

- **OS**: Windows 11 (Build 22000 以降)
- **権限**: 管理者権限 (サービス登録・EcoQoS 制御に必要)

---

## 非対象事項

- **Windows 10**: EcoQoS 機能自体が存在しないため対象外です
- **ARM64**: 未テスト。x64 ビルドのみ提供します

---

## 既知の制限

- **管理者権限が必須**: サービス登録および `SetProcessInformation` API の呼び出しに管理者権限が必要です
- **UWP アプリ**: UWP / ストアアプリは OS による保護が強く、EcoQoS 無効化が効かない場合があります
- **レジストリポリシー**: `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options` にプロセスごとのポリシーを書き込みます。他のツールが同じキーを使用している場合は競合の可能性があります
